{% extends 'base.html' %}

{% block title %}Профиль{% endblock %}

{% block content %}
    <h1>Профиль пользователя {{ user.username }}</h1>

    {% if is_manager %}
        <!-- Управление пользователями -->
        <h2>Управление пользователями</h2>
        {% if users %}
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Имя пользователя</th>
                        <th>Email</th>
                        <th>Статус</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                        <tr>
                            <td>{{ user.username }}</td>
                            <td>{{ user.email }}</td>
                            <td>{{ user.is_active|yesno:"Активен,Заблокирован" }}</td>
                            <td>
                                <form method="post" action="{% url 'rent:toggle_user_active' user.id %}">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-{% if user.is_active %}danger{% else %}success{% endif %}">
                                        {% if user.is_active %}Заблокировать{% else %}Активировать{% endif %}
                                    </button>
                                </form>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p>Нет пользователей.</p>
        {% endif %}

        <!-- Управление бронированиями -->
        <h2>Управление бронированиями</h2>
        {% if all_bookings %}
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>
                            <a href="{% url 'rent:profile' %}?sort={% if current_sort == 'car_asc' %}car_desc{% else %}car_asc{% endif %}" class="sort-link">
                                Автомобиль
                                {% if current_sort == 'car_asc' %}<i class="bi bi-sort-up"></i>{% elif current_sort == 'car_desc' %}<i class="bi bi-sort-down"></i>{% endif %}
                            </a>
                        </th>
                        <th>
                            <a href="{% url 'rent:profile' %}?sort={% if current_sort == 'user_asc' %}user_desc{% else %}user_asc{% endif %}" class="sort-link">
                                Пользователь
                                {% if current_sort == 'user_asc' %}<i class="bi bi-sort-up"></i>{% elif current_sort == 'user_desc' %}<i class="bi bi-sort-down"></i>{% endif %}
                            </a>
                        </th>
                        <th>
                            <a href="{% url 'rent:profile' %}?sort={% if current_sort == 'start_date_asc' %}start_date_desc{% else %}start_date_asc{% endif %}" class="sort-link">
                                Дата начала
                                {% if current_sort == 'start_date_asc' %}<i class="bi bi-sort-up"></i>{% elif current_sort == 'start_date_desc' %}<i class="bi bi-sort-down"></i>{% endif %}
                            </a>
                        </th>
                        <th>
                            <a href="{% url 'rent:profile' %}?sort={% if current_sort == 'end_date_asc' %}end_date_desc{% else %}end_date_asc{% endif %}" class="sort-link">
                                Дата окончания
                                {% if current_sort == 'end_date_asc' %}<i class="bi bi-sort-up"></i>{% elif current_sort == 'end_date_desc' %}<i class="bi bi-sort-down"></i>{% endif %}
                            </a>
                        </th>
                        <th>
                            <a href="{% url 'rent:profile' %}?sort={% if current_sort == 'total_price_asc' %}total_price_desc{% else %}total_price_asc{% endif %}" class="sort-link">
                                Стоимость
                                {% if current_sort == 'total_price_asc' %}<i class="bi bi-sort-up"></i>{% elif current_sort == 'total_price_desc' %}<i class="bi bi-sort-down"></i>{% endif %}
                            </a>
                        </th>
                        <th>
                            <a href="{% url 'rent:profile' %}?sort={% if current_sort == 'status_asc' %}status_desc{% else %}status_asc{% endif %}" class="sort-link">
                                Статус
                                {% if current_sort == 'status_asc' %}<i class="bi bi-sort-up"></i>{% elif current_sort == 'status_desc' %}<i class="bi bi-sort-down"></i>{% endif %}
                            </a>
                        </th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody>
                    {% for booking in all_bookings %}
                        <tr>
                            <td>{{ booking.car.car_model.brand }} {{ booking.car.car_model.model }} ({{ booking.car.year }})</td>
                            <td>{{ booking.user.username }} ({{ booking.user.email }})</td>
                            <td>{{ booking.start_date }}</td>
                            <td>{{ booking.end_date }}</td>
                            <td>{{ booking.total_price }} руб.</td>
                            <td>{{ booking.get_status_display }}</td>
                            <td>
                                <form method="post" action="{% url 'rent:update_booking_status' booking.id %}">
                                    {% csrf_token %}
                                    <select name="status" class="form-select d-inline w-auto">
                                        {% for value, label in booking.STATUS_CHOICES %}
                                            <option value="{{ value }}" {% if booking.status == value %}selected{% endif %}>{{ label }}</option>
                                        {% endfor %}
                                    </select>
                                    <button type="submit" class="btn btn-primary btn-sm">Изменить</button>
                                </form>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p>Нет бронирований.</p>
        {% endif %}
    {% else %}
        <!-- Для обычных пользователей -->
        <h2>Активные аренды</h2>
        {% if active_bookings %}
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Автомобиль</th>
                        <th>Дата начала</th>
                        <th>Дата окончания</th>
                        <th>Стоимость</th>
                        <th>Статус</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody>
                    {% for booking in active_bookings %}
                        <tr>
                            <td>{{ booking.car.car_model.brand }} {{ booking.car.car_model.model }} ({{ booking.car.year }})</td>
                            <td>{{ booking.start_date }}</td>
                            <td>{{ booking.end_date }}</td>
                            <td>{{ booking.total_price }} руб.</td>
                            <td>{{ booking.get_status_display }}</td>
                            <td></td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p>Нет активных аренд.</p>
        {% endif %}

        <h2>История бронирований</h2>
        {% if bookings %}
            <table class="table table-striped table-responsive">
                <thead>
                    <tr>
                        <th>Автомобиль</th>
                        <th>Дата начала</th>
                        <th>Дата окончания</th>
                        <th>Стоимость</th>
                        <th>Статус</th>
                        <th>Действия</th>
                        <th>Дата создания</th>
                    </tr>
                </thead>
                <tbody>
                    {% for booking in bookings %}
                        <tr>
                            <td>{{ booking.car.car_model.brand }} {{ booking.car.car_model.model }} ({{ booking.car.year }})</td>
                            <td>{{ booking.start_date }}</td>
                            <td>{{ booking.end_date }}</td>
                            <td>{{ booking.total_price }} руб.</td>
                            <td>{{ booking.get_status_display }}</td>
                            <td>
                                {% if booking.status == 'pending' %}
                                    <form method="post" action="{% url 'rent:cancel_booking' booking.id %}">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-danger btn-sm">Отменить</button>
                                    </form>
                                {% endif %}
                            </td>
                            <td>{{ booking.created_at|date:"d.m.Y H:i" }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p>Нет бронирований.</p>
        {% endif %}
    {% endif %}
{% endblock %}